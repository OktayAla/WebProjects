{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="text-center"><i class="fas fa-cloud-sun"></i> Premium Hava Durumu</h3>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" name="city" placeholder="Şehir adı girin...">
                            <button class="btn btn-primary" type="submit">Sorgula</button>
                        </div>
                    </form>

                    {% if weather %}
                    <div class="weather-info text-center">
                        <h2>{{ weather.name }}, {{ weather.sys.country }}</h2>
                        <img src="http://openweathermap.org/img/wn/{{ weather.weather[0].icon }}@4x.png" alt="icon">
                        <h1 class="display-4">{{ weather.main.temp }}°C</h1>
                        <p class="lead">{{ weather.weather[0].description | capitalize }}</p>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <p><i class="fas fa-temperature-high"></i> Max: {{ weather.main.temp_max }}°C</p>
                            </div>
                            <div class="col-md-4">
                                <p><i class="fas fa-temperature-low"></i> Min: {{ weather.main.temp_min }}°C</p>
                            </div>
                            <div class="col-md-4">
                                <p><i class="fas fa-tint"></i> Nem: {{ weather.main.humidity }}%</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if forecast %}
                    <div class="mt-5">
                        <h4 class="text-center">Önümüzdeki Saatlerin Sıcaklık Grafiği</h4>
                        <canvas id="forecastChart"></canvas>
                    </div>
                    <!-- Forecast verilerini frontend'e aktarıyoruz -->
                    <script>
                        const forecastData = {{ forecast|tojson }};
                    </script>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Türkiye Haritası Bölümü -->
    {% if cities_weather %}
    <div class="mt-5">
        <h4 class="text-center">Türkiye Haritası Üzerinde Şehirlerin Anlık Hava Durumları</h4>
        <div id="turkeyMap" style="height: 500px;"></div>
    </div>
    <script>
        // Sunucudan gelen şehir hava durumu verileri
        const citiesWeather = {{ cities_weather|tojson }};
        // Haritanın başlangıç koordinatları (Türkiye merkez)
        const map = L.map('turkeyMap').setView([39, 35], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        // Her şehir için marker ekle
        citiesWeather.forEach(city => {
            // Koordinat varsa marker ekleniyor
            if(city.coord) {
                const marker = L.marker([city.coord.lat, city.coord.lon]).addTo(map);
                marker.bindPopup(`<strong>${city.name}</strong><br>${city.main.temp}°C<br>${city.weather[0].description}`);
            }
        });
    </script>
    {% endif %}
</div>
{% endblock %}